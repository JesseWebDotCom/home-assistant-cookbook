(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{128:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return i})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return b}));var r=n(1),a=n(9),c=(n(0),n(157)),o=n(158),s={id:"secrets",title:"Secrets"},i={id:"node-red/tutorials/secrets",title:"Secrets",description:"import useBaseUrl from '@docusaurus/useBaseUrl';",source:"@site/docs/node-red/tutorials/secrets.md",permalink:"/home-assistant-cookbook/docs/node-red/tutorials/secrets",sidebar:"docs",previous:{title:"Tutorials",permalink:"/home-assistant-cookbook/docs/node-red/tutorials/getting-started"},next:{title:"Getting Started",permalink:"/home-assistant-cookbook/docs/esphome/getting-started"}},l=[{value:"The Problem",id:"the-problem",children:[]},{value:"Previous Solution",id:"previous-solution",children:[]},{value:"Current Solution",id:"current-solution",children:[{value:"How it works",id:"how-it-works",children:[]},{value:"Setup",id:"setup",children:[]},{value:"Adding / Editing Secrets",id:"adding--editing-secrets",children:[]},{value:"Accessing Secrets",id:"accessing-secrets",children:[]}]}],d={rightToc:l};function b(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(c.b)("wrapper",Object(r.a)({},d,n,{components:t,mdxType:"MDXLayout"}),Object(c.b)("h2",{id:"the-problem"},"The Problem"),Object(c.b)("p",null,"Throughout your code, you'll need to reference sensitive data such as usernames, passwords, API keys, etc. This is problematic as you may want to share your code with others, backup to Github, etc. While Home Assistant provides an easy way to ",Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.home-assistant.io/docs/configuration/secrets/"}),"redact secrets from your configuration files"),", Node-RED does not."),Object(c.b)("h2",{id:"previous-solution"},"Previous Solution"),Object(c.b)("p",null,"One solution is to use a special node called ",Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.npmjs.com/package/node-red-contrib-credentials"}),"node-red-contrib-credentials"),".  While this approach initially seemed promising, it came with too many drawbacks:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Must add a node everywhere you want to access a secret (this quickly makes a mess of your flows)"),Object(c.b)("li",{parentName:"ul"},"No centralized secrets management - the secrets added in one node are not available to another"),Object(c.b)("li",{parentName:"ul"},"Copy/paste of nodes causes their secrets to be erased")),Object(c.b)("h2",{id:"current-solution"},"Current Solution"),Object(c.b)("p",null,"My current solution is easy to setup, easy to use, and leverages built-in Node-RED features."),Object(c.b)("h3",{id:"how-it-works"},"How it works"),Object(c.b)("p",null,Object(c.b)("a",Object(r.a)({parentName:"p"},{href:"https://nodered.org/docs/user-guide/context"}),"Context"),' is a way you can share data between nodes and flows without using the msg object.  My solution leverages our own custom, persistent context storage we\'ll call "secrets".  By using the ',Object(c.b)("inlineCode",{parentName:"p"},"global")," keyword whenever we read/write secrets, we are able to access our secrets across all nodes and flows."),Object(c.b)("p",null,"Ultimately, all secrets are stored, in plain text, in ",Object(c.b)("inlineCode",{parentName:"p"},"/config/node-red/secrets/global/global.json"),"."),Object(c.b)("div",{className:"admonition admonition-warning"},Object(c.b)("div",Object(r.a)({parentName:"div"},{className:"admonition-heading"}),Object(c.b)("h5",{parentName:"div"},Object(c.b)("div",Object(r.a)({parentName:"h5"},{className:"admonition-icon"}),Object(c.b)("svg",Object(r.a)({parentName:"div"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(c.b)("path",Object(r.a)({parentName:"svg"},{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})))),"warning")),Object(c.b)("div",Object(r.a)({parentName:"div"},{className:"admonition-content"}),Object(c.b)("p",{parentName:"div"},"Be sure to exclude the /config/node-red/secrets path in your .gitignore file (since the secrets are stored in plain text)."))),Object(c.b)("h3",{id:"setup"},"Setup"),Object(c.b)("ol",null,Object(c.b)("li",{parentName:"ol"},"Add the following section to your settings.js:")),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{className:"language-json"}),'    contextStorage: {\n        default    : { module: "memory" },\n        secrets: { \n            module: "localfilesystem",\n            config: {\n                dir: "/config/node-red",\n                base: "secrets"\n            }\n        }\n    },\n')),Object(c.b)("ol",{start:2},Object(c.b)("li",{parentName:"ol"},"Restart Node-RED")),Object(c.b)("h3",{id:"adding--editing-secrets"},"Adding / Editing Secrets"),Object(c.b)("p",null,"You can manually create and or edit the secrets file (",Object(c.b)("inlineCode",{parentName:"p"},"/config/node-red/secrets/global/global.json"),"):"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{className:"language-javascript"}),'{\n    "first_secret": "123",\n    "second_secret": "abc"\n}\n')),Object(c.b)("div",{className:"admonition admonition-note"},Object(c.b)("div",Object(r.a)({parentName:"div"},{className:"admonition-heading"}),Object(c.b)("h5",{parentName:"div"},Object(c.b)("div",Object(r.a)({parentName:"h5"},{className:"admonition-icon"}),Object(c.b)("svg",Object(r.a)({parentName:"div"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(c.b)("path",Object(r.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(c.b)("div",Object(r.a)({parentName:"div"},{className:"admonition-content"}),Object(c.b)("p",{parentName:"div"},"While immediately available in memory, secrets modifications through Node-RED (i.e. the methods below) will take a few seoncds to write the changes to the secrets file."))),Object(c.b)("p",null,"You can also create and or edit each secret by running the below in a function node (replacing ",Object(c.b)("inlineCode",{parentName:"p"},"your_key")," and ",Object(c.b)("inlineCode",{parentName:"p"},"your_value")," appropriately):"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{className:"language-javascript"}),'global.set("your_key", "your_value", "secrets");\n')),Object(c.b)("p",null,"And you can even create and or edit secrets with change nodes:"),Object(c.b)("img",{alt:"Secret Edit",src:Object(o.a)("img/nodered-secrets-edit-change.png")}),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{className:"language-json"}),'[{"id":"bf2ad73a.23bdb8","type":"change","z":"977bc9ad.687238","name":"Save Secret","rules":[{"t":"set","p":"#:(secrets)::some_secret","pt":"global","to":"some_value","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":260,"wires":[[]]},{"id":"5c5c19b4.549de8","type":"inject","z":"977bc9ad.687238","name":"Press","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":260,"wires":[["bf2ad73a.23bdb8"]]}]\n')),Object(c.b)("h3",{id:"accessing-secrets"},"Accessing Secrets"),Object(c.b)("p",null,'You can access secrets through any node that can access context (be sure to select the "secrets" context storage).'),Object(c.b)("p",null,"ex. the inject node:"),Object(c.b)("img",{alt:"Secrets Access",src:Object(o.a)("img/nodered-secrets-access-inject.png")}),Object(c.b)("p",null,"ex. the change node:"),Object(c.b)("img",{alt:"Secrets Access",src:Object(o.a)("img/nodered-secrets-access-change.png")}),Object(c.b)("p",null,"ex. the switch node:"),Object(c.b)("img",{alt:"Secrets Access",src:Object(o.a)("img/nodered-secrets-access-switch.png")}),Object(c.b)("p",null,"You can also access through the function node:"),Object(c.b)("pre",null,Object(c.b)("code",Object(r.a)({parentName:"pre"},{className:"language-javascript"}),'var secret = global.get("your_key", "secrets");\n')))}b.isMDXComponent=!0},156:function(e,t,n){"use strict";var r=n(0),a=n(48);t.a=function(){return Object(r.useContext)(a.a)}},157:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},c=Object.keys(e);for(r=0;r<c.length;r++)n=c[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(r=0;r<c.length;r++)n=c[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),d=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s({},t,{},e)),n},b=function(e){var t=d(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},p=Object(r.forwardRef)((function(e,t){var n=e.components,r=e.mdxType,c=e.originalType,o=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),b=d(n),p=r,m=b["".concat(o,".").concat(p)]||b[p]||u[p]||c;return n?a.a.createElement(m,s({ref:t},l,{components:n})):a.a.createElement(m,s({ref:t},l))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var c=n.length,o=new Array(c);o[0]=p;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<c;l++)o[l]=n[l];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},158:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));n(159);var r=n(156);function a(e){var t=(Object(r.a)().siteConfig||{}).baseUrl,n=void 0===t?"/":t;if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?n+e.slice(1):n+e}},159:function(e,t,n){"use strict";var r=n(17),a=n(34),c=n(160),o="".startsWith;r(r.P+r.F*n(161)("startsWith"),"String",{startsWith:function(e){var t=c(this,e,"startsWith"),n=a(Math.min(arguments.length>1?arguments[1]:void 0,t.length)),r=String(e);return o?o.call(t,r,n):t.slice(n,n+r.length)===r}})},160:function(e,t,n){var r=n(69),a=n(23);e.exports=function(e,t,n){if(r(t))throw TypeError("String#"+n+" doesn't accept regex!");return String(a(e))}},161:function(e,t,n){var r=n(2)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(n){try{return t[r]=!1,!"/./"[e](t)}catch(a){}}return!0}}}]);